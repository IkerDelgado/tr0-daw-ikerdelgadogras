<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin CRUD Preguntes</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .card { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 18px; margin-bottom: 18px; }
    .resposta-list { margin-top: 10px; }
    .resposta-item { display: flex; align-items: center; margin-bottom: 6px; }
    .resposta-item input { margin-right: 8px; }
    .actions button { margin-right: 8px; }
    .correcta-label { color: #1976d2; font-weight: bold; margin-left: 8px; }
    .add-btn { background: #1976d2; color: #fff; border: none; padding: 6px 14px; border-radius: 4px; cursor: pointer; }
    .add-btn:hover { background: #1565c0; }
  </style>
</head>
<body>
  <div class="container py-4">
    <h1 class="mb-4 text-center text-break">Gestió de Preguntes (CRUD)</h1>
    <div id="preguntes"></div>
    <hr>
    <h2 class="text-center">Crear nova pregunta</h2>
    <form id="form-nova-pregunta" class="mb-3">
      <input type="text" id="nova-pregunta" placeholder="Pregunta" required class="form-control mb-2 w-100" style="max-width:500px;">
      <button type="button" class="add-btn mb-2 w-100" id="crear-pregunta-btn">Crear pregunta</button>
    </form>
    <div id="error-msg" style="color:red;margin-top:10px;"></div>
  </div>
  <style>
    @media (max-width: 600px) {
      .card { padding: 10px; }
      .resposta-item { flex-direction: column; align-items: flex-start; }
      .resposta-item input, .resposta-item label, .resposta-item img { margin-bottom: 6px; }
      h1, h2 { font-size: 1.2em; }
    }
  </style>
  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // --- Helpers ---
    function fetchPreguntes() {
      fetch('api/get_questions.php')
        .then(r => r.json())
        .then(data => renderPreguntes(data.preguntes));
    }
    
    function renderPreguntes(preguntes) {
      const div = document.getElementById('preguntes');
      div.innerHTML = '';
      preguntes.forEach(p => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `<b>Pregunta:</b> <span>${p.pregunta}</span><br>`;
        const resList = document.createElement('div');
        resList.className = 'resposta-list';
        p.respostes.forEach(r => {
          const item = document.createElement('div');
          item.className = 'resposta-item';
          item.innerHTML = `<img src="${r.imatge}" width="32" height="32"> <b>${r.etiqueta}</b> ${r.correcta == 1 ? '<span class="correcta-label">(Correcta)</span>' : ''}`;
          resList.appendChild(item);
        });
        card.appendChild(resList);
        // Acciones
        const actions = document.createElement('div');
        actions.className = 'actions';
        actions.innerHTML = `<button onclick="editPregunta(${p.id})">Editar</button><button onclick="deletePregunta(${p.id})">Eliminar</button>`;
        card.appendChild(actions);
        div.appendChild(card);
      });
    }
    
    // --- Crear pregunta ---
    document.getElementById('crear-pregunta-btn').onclick = function() {
      document.getElementById('error-msg').textContent = '';
      const pregunta = document.getElementById('nova-pregunta').value.trim();
      if (!pregunta) {
        document.getElementById('error-msg').textContent = 'Escribe la pregunta antes de continuar.';
        return;
      }
      
      let modal = document.createElement('div');
      modal.style.position = 'fixed';
      modal.style.top = '0';
      modal.style.left = '0';
      modal.style.width = '100vw';
      modal.style.height = '100vh';
      modal.style.background = 'rgba(0,0,0,0.3)';
      modal.style.zIndex = '9999';
      
      let modalHtml = `<div style='background:#fff;padding:24px;border-radius:8px;max-width:500px;margin:60px auto;'>
        <h3>Introduce las 4 respuestas</h3>
        <form id='modal-form'>`;
      
      for (let i = 0; i < 4; i++) {
        modalHtml += `<div class='resposta-item' style='margin-bottom:10px;'>
          <input type='text' id='modal-etiqueta-${i}' placeholder='Etiqueta' style='margin-right:10px;'>
          <input type='file' id='modal-imatge-${i}' accept='image/*' style='margin-right:10px;'>
          <label><input type='radio' name='modal-correcta' value='${i}' id='modal-correcta-${i}'> Correcta</label>
        </div>`;
      }
      
      modalHtml += `<br><button type='submit' class='add-btn'>Guardar</button>
        <button type='button' id='cancelar-modal' class='add-btn' style='background:#aaa;'>Cancelar</button>
        <div id='modal-error' style='color:red;margin-top:10px;'></div>
        </form></div>`;
      
      modal.innerHTML = modalHtml;
      document.body.appendChild(modal);
      
      document.getElementById('cancelar-modal').onclick = function() {
        document.body.removeChild(modal);
      };
      
      document.getElementById('modal-form').onsubmit = function(e) {
        e.preventDefault();
        
        // Verificar que hay una respuesta correcta seleccionada
        const radioSeleccionado = document.querySelector('input[name="modal-correcta"]:checked');
        if (!radioSeleccionado) {
          document.getElementById('modal-error').textContent = 'Marca una respuesta como correcta.';
          return;
        }
        
        const correctaIndex = parseInt(radioSeleccionado.value);
        
        // Verificar que todas las etiquetas están completas
        let todasCompletas = true;
        for (let i = 0; i < 4; i++) {
          let etiqueta = document.getElementById('modal-etiqueta-' + i).value.trim();
          if (!etiqueta) {
            todasCompletas = false;
            break;
          }
        }
        
        if (!todasCompletas) {
          document.getElementById('modal-error').textContent = 'Completa las 4 etiquetas.';
          return;
        }
        
        // Construir FormData correctamente
        const formData = new FormData();
        formData.append('pregunta', pregunta);
        
        for (let i = 0; i < 4; i++) {
          let etiqueta = document.getElementById('modal-etiqueta-' + i).value.trim();
          let imatgeFile = document.getElementById('modal-imatge-' + i).files[0];
          let correcta = (i === correctaIndex) ? 1 : 0;
          
          // Importante: usar esta estructura para que PHP pueda leer los datos correctamente
          formData.append(`respostes[${i}][etiqueta]`, etiqueta);
          formData.append(`respostes[${i}][correcta]`, correcta);
          if (imatgeFile) {
            formData.append(`respostes[${i}][imatge]`, imatgeFile);
          } else {
            formData.append(`respostes[${i}][imatge]`, '');
          }
        }
        
        fetch('api/create_question.php', {
          method: 'POST',
          body: formData
        })
        .then(r => r.json())
        .then((data) => {
          if (!data.success) {
            document.getElementById('modal-error').textContent = data.error || 'Error desconocido.';
            return;
          }
          document.getElementById('nova-pregunta').value = '';
          document.body.removeChild(modal);
          fetchPreguntes();
        })
        .catch(error => {
          document.getElementById('modal-error').textContent = 'Error de conexión: ' + error.message;
        });
      };
    };
    
    // --- Eliminar pregunta ---
    window.deletePregunta = function(id) {
      if (!confirm('¿Seguro que quieres eliminar esta pregunta?')) return;
      fetch('api/delete_question.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id })
      }).then(r => r.json()).then(() => fetchPreguntes());
    };
    
    // --- Editar pregunta (modal simple) ---
    window.editPregunta = function(id) {
      fetch('api/get_questions.php')
        .then(r => r.json())
        .then(data => {
          const p = data.preguntes.find(q => q.id == id);
          if (!p) return;
          const nuevaPregunta = prompt('Edita la pregunta:', p.pregunta);
          if (nuevaPregunta === null) return;
          
          // Editar respuestas
          let nuevasRespuestas = JSON.parse(JSON.stringify(p.respostes));
          let editHtml = 'Edita les respostas (marca la correcta):<br>';
          nuevasRespuestas.forEach((r, i) => {
            editHtml += `<div class='resposta-item'>
              <input type='text' id='edit-etiqueta-${i}' value='${r.etiqueta}'>
              <input type='text' id='edit-imatge-${i}' value='${r.imatge}'>
              <label><input type='radio' name='edit-correcta' ${r.correcta == 1 ? 'checked' : ''} onclick='window.setEditCorrecta(${i})'> Correcta</label>
            </div>`;
          });
          
          const modal = document.createElement('div');
          modal.style.position = 'fixed';
          modal.style.top = '0';
          modal.style.left = '0';
          modal.style.width = '100vw';
          modal.style.height = '100vh';
          modal.style.background = 'rgba(0,0,0,0.3)';
          modal.style.zIndex = '9999';
          modal.innerHTML = `<div style='background:#fff;padding:24px;border-radius:8px;max-width:500px;margin:60px auto;'>
            <h3>Edita pregunta</h3>
            <input type='text' id='modal-pregunta' value='${nuevaPregunta}' style='width:90%'><br><br>
            ${editHtml}
            <br><button id='guardar-edit' class='add-btn'>Guardar</button>
            <button id='cancelar-edit' class='add-btn' style='background:#aaa;'>Cancelar</button>
          </div>`;
          
          document.body.appendChild(modal);
          
          window.setEditCorrecta = function(idx) {
            nuevasRespuestas.forEach((r, i) => r.correcta = i === idx ? 1 : 0);
          };
          
          document.getElementById('guardar-edit').onclick = function() {
            const preguntaEditada = document.getElementById('modal-pregunta').value;
            nuevasRespuestas.forEach((r, i) => {
              r.etiqueta = document.getElementById('edit-etiqueta-' + i).value;
              r.imatge = document.getElementById('edit-imatge-' + i).value;
            });
            
            fetch('api/update_question.php', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id, pregunta: preguntaEditada, respostes: nuevasRespuestas })
            }).then(r => r.json()).then(() => {
              document.body.removeChild(modal);
              fetchPreguntes();
            });
          };
          
          document.getElementById('cancelar-edit').onclick = function() {
            document.body.removeChild(modal);
          };
        });
    };

    // Inicializar
    fetchPreguntes();
  </script>
</body>
</html>