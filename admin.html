<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin CRUD Preguntes</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 30px; }
    .card { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 18px; margin-bottom: 18px; }
    .resposta-list { margin-top: 10px; }
    .resposta-item { display: flex; align-items: center; margin-bottom: 6px; }
    .resposta-item input { margin-right: 8px; }
    .actions button { margin-right: 8px; }
    .correcta-label { color: #1976d2; font-weight: bold; margin-left: 8px; }
    .add-btn { background: #1976d2; color: #fff; border: none; padding: 6px 14px; border-radius: 4px; cursor: pointer; }
    .add-btn:hover { background: #1565c0; }
  </style>
</head>
<body>
  <h1>Gestió de Preguntes (CRUD)</h1>
  <div id="preguntes"></div>
  <hr>
  <h2>Crear nova pregunta</h2>
  <form id="form-nova-pregunta">
    <input type="text" id="nova-pregunta" placeholder="Pregunta" required style="width:60%">
    <div id="respostes-noves" class="resposta-list"></div>
    <button type="button" class="add-btn" id="afegir-resposta">Afegir resposta</button>
    <br><br>
    <button type="submit" class="add-btn">Crear pregunta</button>
  </form>
  <script>
    // --- Helpers ---
    function fetchPreguntes() {
      fetch('api/get_questions.php')
        .then(r => r.json())
        .then(data => renderPreguntes(data.preguntes));
    }
    function renderPreguntes(preguntes) {
      const div = document.getElementById('preguntes');
      div.innerHTML = '';
      preguntes.forEach(p => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `<b>Pregunta:</b> <span>${p.pregunta}</span><br>`;
        const resList = document.createElement('div');
        resList.className = 'resposta-list';
        p.respostes.forEach(r => {
          const item = document.createElement('div');
          item.className = 'resposta-item';
          item.innerHTML = `<img src="${r.imatge}" width="32" height="32"> <b>${r.etiqueta}</b> ${r.correcta == 1 ? '<span class="correcta-label">(Correcta)</span>' : ''}`;
          resList.appendChild(item);
        });
        card.appendChild(resList);
        // Acciones
        const actions = document.createElement('div');
        actions.className = 'actions';
        actions.innerHTML = `<button onclick="editPregunta(${p.id})">Editar</button><button onclick="deletePregunta(${p.id})">Eliminar</button>`;
        card.appendChild(actions);
        div.appendChild(card);
      });
    }
    // --- Crear pregunta ---
    let respostesNoves = [];
    function renderRespostesNoves() {
      const cont = document.getElementById('respostes-noves');
      cont.innerHTML = '';
      respostesNoves.forEach((r, i) => {
        cont.innerHTML += `<div class='resposta-item'>
          <input type='text' placeholder='Etiqueta' value='${r.etiqueta || ''}' onchange='updateEtiqueta(${i}, this.value)'>
          <input type='text' placeholder='Imatge URL' value='${r.imatge || ''}' onchange='updateImatge(${i}, this.value)'>
          <label><input type='radio' name='correcta' ${r.correcta ? 'checked' : ''} onchange='setCorrecta(${i})'> Correcta</label>
          <button type='button' onclick='removeResposta(${i})'>X</button>
        </div>`;
      });
    }
    window.updateEtiqueta = function(i, val) { respostesNoves[i].etiqueta = val; }
    window.updateImatge = function(i, val) { respostesNoves[i].imatge = val; }
    window.setCorrecta = function(i) { respostesNoves.forEach((r, idx) => r.correcta = idx === i); renderRespostesNoves(); }
    window.removeResposta = function(i) { respostesNoves.splice(i, 1); renderRespostesNoves(); }
    document.getElementById('afegir-resposta').onclick = function() {
      respostesNoves.push({ etiqueta: '', imatge: '', correcta: false });
      renderRespostesNoves();
    };
    document.getElementById('form-nova-pregunta').onsubmit = function(e) {
      e.preventDefault();
      const pregunta = document.getElementById('nova-pregunta').value.trim();
      if (!pregunta || respostesNoves.length < 2 || !respostesNoves.some(r => r.correcta)) {
        alert('Completa la pregunta y al menos dos respuestas, marcando una como correcta.');
        return;
      }
      fetch('api/create_question.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ pregunta, respostes: respostesNoves })
      }).then(r => r.json()).then(() => {
        document.getElementById('nova-pregunta').value = '';
        respostesNoves = [];
        renderRespostesNoves();
        fetchPreguntes();
      });
    };
    // --- Eliminar pregunta ---
    window.deletePregunta = function(id) {
      if (!confirm('¿Seguro que quieres eliminar esta pregunta?')) return;
      fetch('api/delete_question.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id })
      }).then(r => r.json()).then(() => fetchPreguntes());
    };
    // --- Editar pregunta (modal simple) ---
    window.editPregunta = function(id) {
      fetch('api/get_questions.php')
        .then(r => r.json())
        .then(data => {
          const p = data.preguntes.find(q => q.id == id);
          if (!p) return;
          const nuevaPregunta = prompt('Edita la pregunta:', p.pregunta);
          if (nuevaPregunta === null) return;
          // Editar respuestas
          let nuevasRespuestas = JSON.parse(JSON.stringify(p.respostes));
          let editHtml = 'Edita las respuestas (marca la correcta):<br>';
          nuevasRespuestas.forEach((r, i) => {
            editHtml += `<div class='resposta-item'>
              <input type='text' id='edit-etiqueta-${i}' value='${r.etiqueta}'>
              <input type='text' id='edit-imatge-${i}' value='${r.imatge}'>
              <label><input type='radio' name='edit-correcta' ${r.correcta == 1 ? 'checked' : ''} onclick='window.setEditCorrecta(${i})'> Correcta</label>
            </div>`;
          });
          const modal = document.createElement('div');
          modal.style.position = 'fixed';
          modal.style.top = '0';
          modal.style.left = '0';
          modal.style.width = '100vw';
          modal.style.height = '100vh';
          modal.style.background = 'rgba(0,0,0,0.3)';
          modal.style.zIndex = '9999';
          modal.innerHTML = `<div style='background:#fff;padding:24px;border-radius:8px;max-width:500px;margin:60px auto;'>
            <h3>Edita pregunta</h3>
            <input type='text' id='modal-pregunta' value='${nuevaPregunta}' style='width:90%'><br><br>
            ${editHtml}
            <br><button id='guardar-edit' class='add-btn'>Guardar</button>
            <button id='cancelar-edit' class='add-btn' style='background:#aaa;'>Cancelar</button>
          </div>`;
          document.body.appendChild(modal);
          window.setEditCorrecta = function(idx) {
            nuevasRespuestas.forEach((r, i) => r.correcta = i === idx ? 1 : 0);
          };
          document.getElementById('guardar-edit').onclick = function() {
            const preguntaEditada = document.getElementById('modal-pregunta').value;
            nuevasRespuestas.forEach((r, i) => {
              r.etiqueta = document.getElementById('edit-etiqueta-' + i).value;
              r.imatge = document.getElementById('edit-imatge-' + i).value;
            });
            fetch('api/update_question.php', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id, pregunta: preguntaEditada, respostes: nuevasRespuestas })
            }).then(r => r.json()).then(() => {
              document.body.removeChild(modal);
              fetchPreguntes();
            });
          };
          document.getElementById('cancelar-edit').onclick = function() {
            document.body.removeChild(modal);
          };
        });
    };
    // Inicializar
    renderRespostesNoves();
    fetchPreguntes();
  </script>
</body>
</html>
